name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Frontend Tests
  frontend-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run linter
      run: npm run lint

    - name: Run tests
      run: npm test

    - name: Build frontend
      run: npm run build

  # Backend Tests
  backend-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install uv
      run: pip install uv

    - name: Install dependencies
      run: |
        uv pip install --system -r <(uv export --no-hashes --format requirements-txt)
        python -c "import nltk; nltk.download('punkt'); nltk.download('stopwords'); nltk.download('wordnet'); nltk.download('punkt_tab')"
        python -m textblob.download_corpora

    - name: Run tests
      run: pytest tests/ -v --tb=short

    - name: Run integration tests
      run: pytest tests/integration/ -v --tb=short

  # Integration Tests (Full Stack)
  integration-tests:
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]

    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image
      run: docker build -t study-kit:test .

    - name: Run container
      run: |
        docker run -d -p 8000:8000 --name study-kit-test study-kit:test
        sleep 30

    - name: Test health endpoint
      run: |
        curl -f http://localhost:8000/health || exit 1

    - name: Test API endpoints
      run: |
        curl -f -X POST http://localhost:8000/api/summarize \
          -H "Content-Type: application/json" \
          -d '{"text":"This is a test sentence. It has multiple sentences. We want to summarize it."}' || exit 1

    - name: Stop container
      run: docker stop study-kit-test

  # Deploy to Render (only on main branch)
  deploy:
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests, integration-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - name: Deploy to Render
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_SERVICE_ID" ]; then
          curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json"
          echo "Deployment triggered successfully"
        else
          echo "Render credentials not configured - skipping deployment"
          echo "Configure RENDER_API_KEY and RENDER_SERVICE_ID secrets in GitHub to enable auto-deployment"
        fi
